# ğŸ”§ ç™»å½•åç«‹å³é€€å‡ºé—®é¢˜ - è¯Šæ–­ä¸ä¿®å¤æŠ¥å‘Š

## ğŸ› é—®é¢˜æè¿°

ä½¿ç”¨æµ‹è¯•è´¦å·ç™»å½•å,å‡ºç°"ç™»å½•æˆåŠŸ"æç¤º,ä½†éšå³åˆé€€å‡ºåˆ°ç™»å½•é¡µé¢,å¯¼è‡´æ— æ³•æ­£å¸¸è¿›å…¥ç³»ç»Ÿã€‚

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜1: å“åº”å¼çŠ¶æ€æ›´æ–°å»¶è¿Ÿ âš ï¸

**ä½ç½®**: `src/views/Login.vue` çš„ `onSuccess` å›è°ƒ

```typescript
onSuccess: (data) => {
  userStore.login(data.token, data.user)  // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
  
  const redirect = getDefaultRoute()  // âŒ é—®é¢˜åœ¨è¿™é‡Œ!
  router.push(redirect)
}

function getDefaultRoute() {
  const role = userStore.userRole  // computed å€¼å¯èƒ½è¿˜æ²¡æ›´æ–°
  // ...
}
```

**åŸå› **:
- `userStore.login()` åˆšæ‰§è¡Œå®Œ,è®¾ç½®äº† `userInfo.value`
- ä½† `userRole` æ˜¯ä¸€ä¸ª computed å€¼: `computed(() => userInfo.value?.role)`
- Vue çš„å“åº”å¼æ›´æ–°æ˜¯**å¼‚æ­¥**çš„,computed å€¼å¯èƒ½è¿˜æ²¡æœ‰ç«‹å³æ›´æ–°
- å¯¼è‡´ `userStore.userRole` å¯èƒ½è¿”å› `undefined`
- `getDefaultRoute()` è¿”å›é»˜è®¤è·¯ç”± `/dashboard` è€Œä¸æ˜¯æ­£ç¡®çš„è·¯ç”±

### é—®é¢˜2: è·¯ç”±å®ˆå«æƒé™æ£€æŸ¥å¤±è´¥ âŒ

**ä½ç½®**: `src/router/index.ts` è·¯ç”±å®ˆå«

```typescript
router.beforeEach((to, from, next) => {
  // ...
  
  // æ£€æŸ¥è§’è‰²æƒé™
  if (to.meta.roles && Array.isArray(to.meta.roles)) {
    const hasPermission = userStore.hasRole(to.meta.roles)
    if (!hasPermission) {
      next('/403')  // âŒ è·³è½¬åˆ° 403
      return
    }
  }
})
```

**åœºæ™¯**:
1. ç®¡ç†å‘˜ç™»å½•å,åº”è¯¥è·³è½¬åˆ° `/admin/dashboard`
2. ä½†ç”±äºé—®é¢˜1,å®é™…è·³è½¬åˆ°äº† `/dashboard`
3. `/dashboard` è·¯ç”±é…ç½®:
   ```typescript
   {
     path: '/dashboard',
     meta: { roles: [UserRole.RESEARCHER, UserRole.EXPERT, UserRole.ADMIN, UserRole.MANAGER] }
   }
   ```
4. è·¯ç”±å®ˆå«æ£€æŸ¥æƒé™æ—¶,å¦‚æœ `userInfo` æœªæ­£ç¡®åŠ è½½,`hasRole()` è¿”å› `false`
5. è¢«é‡å®šå‘åˆ° `/403` é¡µé¢

### é—®é¢˜3: å¾ªç¯è·³è½¬å‡è±¡ ğŸ”„

è™½ç„¶çœ‹èµ·æ¥åƒ"é€€å‡ºç™»å½•",ä½†å®é™…ä¸Šæ˜¯:
1. ç™»å½•æˆåŠŸ â†’ è·³è½¬åˆ°é”™è¯¯çš„è·¯ç”±
2. æƒé™æ£€æŸ¥å¤±è´¥ â†’ è·³è½¬åˆ° `/403`
3. `/403` é¡µé¢ä¸éœ€è¦ç™»å½•,ä½†ç”¨æˆ·çœ‹åˆ°çš„æ˜¯"æ— æƒé™"
4. æˆ–è€…åœ¨æŸäº›æƒ…å†µä¸‹,å¯èƒ½å†æ¬¡è·³è½¬åˆ° `/login`

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤1: ä½¿ç”¨ç›´æ¥ä¼ å…¥çš„ role å€¼ âœ¨

**æ–‡ä»¶**: `src/views/Login.vue`

```typescript
onSuccess: (data) => {
  // å…ˆä¿å­˜ç™»å½•ä¿¡æ¯
  userStore.login(data.token, data.user)
  ElMessage.success('ç™»å½•æˆåŠŸ')

  // âœ… ä½¿ç”¨ data.user.role è€Œä¸æ˜¯ userStore.userRole
  const redirect = typeof route.query.redirect === 'string' && route.query.redirect
    ? route.query.redirect
    : getDefaultRouteByRole(data.user.role)  // ç›´æ¥ä¼ å…¥ role
  
  // âœ… ä½¿ç”¨ setTimeout ç¡®ä¿çŠ¶æ€æ›´æ–°å®Œæˆåå†è·³è½¬
  setTimeout(() => {
    router.push(redirect)
  }, 100)
}

// âœ… æ–°å‡½æ•°:æ¥å— role å‚æ•°
function getDefaultRouteByRole(role: string) {
  if (role === 'admin' || role === 'manager') {
    return '/admin/dashboard'
  } else if (role === 'expert') {
    return '/expert/reviews'
  }
  return '/dashboard'
}
```

**æ”¹è¿›ç‚¹**:
1. ç›´æ¥ä½¿ç”¨ `data.user.role`,é¿å…ä¾èµ– computed å€¼
2. æ·»åŠ  100ms å»¶è¿Ÿ,ç¡®ä¿ Pinia store çŠ¶æ€å®Œå…¨æ›´æ–°
3. å‡½æ•°æ¥å—å‚æ•°,æ›´åŠ å¯æµ‹è¯•å’Œå¯é 

### ä¿®å¤2: å¢å¼ºè·¯ç”±å®ˆå«çš„å¥å£®æ€§ ğŸ›¡ï¸

**æ–‡ä»¶**: `src/router/index.ts`

```typescript
router.beforeEach((to, from, next) => {
  const userStore = useUserStore()
  
  // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯ (ä» localStorage æ¢å¤)
  if (!userStore.userInfo && userStore.token) {
    userStore.initUserInfo()
  }

  // éœ€è¦ç™»å½•çš„é¡µé¢
  if (to.meta.requiresAuth !== false) {
    if (!userStore.isLoggedIn) {
      next({ path: '/login', query: { redirect: to.fullPath } })
      return
    }

    // âœ… æ£€æŸ¥è§’è‰²æƒé™ - ç¡®ä¿ userInfo å·²åŠ è½½
    if (to.meta.roles && Array.isArray(to.meta.roles)) {
      // âœ… æ–°å¢:æ£€æŸ¥ userInfo æ˜¯å¦å­˜åœ¨
      if (!userStore.userInfo) {
        console.warn('ç”¨æˆ·ä¿¡æ¯æœªåŠ è½½,æ‹’ç»è®¿é—®:', to.path)
        next({ path: '/login', query: { redirect: to.fullPath } })
        return
      }
      
      const hasPermission = userStore.hasRole(to.meta.roles)
      if (!hasPermission) {
        // âœ… æ–°å¢:è°ƒè¯•æ—¥å¿—
        console.warn('æƒé™ä¸è¶³,ç”¨æˆ·è§’è‰²:', userStore.userInfo?.role, 'éœ€è¦è§’è‰²:', to.meta.roles)
        next('/403')
        return
      }
    }
  }

  // ...
})
```

**æ”¹è¿›ç‚¹**:
1. æ£€æŸ¥ `userInfo` æ˜¯å¦å­˜åœ¨,é¿å…åœ¨ä¿¡æ¯æœªåŠ è½½æ—¶è¿›è¡Œæƒé™åˆ¤æ–­
2. æ·»åŠ è°ƒè¯•æ—¥å¿—,å¸®åŠ©æ’æŸ¥æƒé™é—®é¢˜
3. å¦‚æœä¿¡æ¯æœªåŠ è½½,é‡å®šå‘å›ç™»å½•é¡µè€Œä¸æ˜¯ 403

### ä¿®å¤3: ä¼˜åŒ– login å‡½æ•°å¹¶æ·»åŠ æ—¥å¿— ğŸ“

**æ–‡ä»¶**: `src/stores/user.ts`

```typescript
function login(newToken, user) {
  // âœ… å…ˆæ›´æ–°å†…å­˜ä¸­çš„æ•°æ® (åŒæ­¥æ“ä½œ,ç«‹å³ç”Ÿæ•ˆ)
  token.value = newToken
  userInfo.value = user
  
  // å†ä¿å­˜åˆ° localStorage
  const success = safeSetItem('token', newToken) && 
                  safeSetItem('userInfo', JSON.stringify(user))
  
  if (!success) {
    token.value = ''
    userInfo.value = null
    throw new AppError(
      'ç™»å½•ä¿¡æ¯ä¿å­˜å¤±è´¥',
      ErrorType.RUNTIME,
      'LOGIN_SAVE_ERROR'
    )
  }
  
  // âœ… æ–°å¢:æ·»åŠ æ—¥å¿—,å¸®åŠ©è°ƒè¯•
  console.log('âœ… ç™»å½•æˆåŠŸ:', {
    username: user?.name,
    role: user?.role,
    token: newToken?.substring(0, 20) + '...'
  })
}
```

**æ”¹è¿›ç‚¹**:
1. æ˜ç¡®æ³¨é‡ŠåŒæ­¥æ›´æ–°çš„é‡è¦æ€§
2. æ·»åŠ æˆåŠŸæ—¥å¿—,ä¾¿äºè°ƒè¯•
3. ç¡®ä¿çŠ¶æ€æ›´æ–°é¡ºåºæ­£ç¡®

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰æµç¨‹ âŒ

```
1. ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç  â†’ ç‚¹å‡»ç™»å½•
2. API è¿”å› { token, user: { role: 'admin' } }
3. userStore.login(token, user) æ‰§è¡Œ
4. getDefaultRoute() è°ƒç”¨ userStore.userRole
5. âš ï¸ userRole (computed) è¿˜æ²¡æ›´æ–°,è¿”å› undefined
6. âš ï¸ é»˜è®¤è·³è½¬åˆ° /dashboard
7. è·¯ç”±å®ˆå«æ£€æŸ¥ /dashboard æƒé™
8. âš ï¸ userInfo å¯èƒ½è¿˜æœªå®Œå…¨åŠ è½½
9. âš ï¸ hasRole() è¿”å› false
10. âŒ è·³è½¬åˆ° /403 æˆ–é‡æ–°ç™»å½•
```

### ä¿®å¤åæµç¨‹ âœ…

```
1. ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç  â†’ ç‚¹å‡»ç™»å½•
2. API è¿”å› { token, user: { role: 'admin' } }
3. userStore.login(token, user) æ‰§è¡Œ
4. âœ… ç›´æ¥ä½¿ç”¨ data.user.role (ä¸ä¾èµ– computed)
5. âœ… getDefaultRouteByRole('admin') è¿”å› '/admin/dashboard'
6. âœ… setTimeout ç­‰å¾… 100ms ç¡®ä¿çŠ¶æ€æ›´æ–°
7. âœ… è·³è½¬åˆ° /admin/dashboard
8. è·¯ç”±å®ˆå«æ£€æŸ¥æƒé™
9. âœ… userInfo å·²å­˜åœ¨,role = 'admin'
10. âœ… æƒé™æ£€æŸ¥é€šè¿‡
11. âœ… æˆåŠŸè¿›å…¥ç®¡ç†å‘˜é¡µé¢
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è´¦å·

| è´¦å· | å¯†ç  | è§’è‰² | åº”è·³è½¬åˆ° |
|------|------|------|----------|
| admin | admin123 | admin | /admin/dashboard |
| expert | expert123 | expert | /expert/reviews |
| researcher | researcher123 | researcher | /dashboard |

### éªŒè¯æ­¥éª¤

1. âœ… æ¸…ç©º localStorage
2. âœ… ä½¿ç”¨æµ‹è¯•è´¦å·ç™»å½•
3. âœ… è§‚å¯Ÿæµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—
4. âœ… ç¡®è®¤æˆåŠŸè·³è½¬åˆ°æ­£ç¡®é¡µé¢
5. âœ… åˆ·æ–°é¡µé¢,ç¡®è®¤ç™»å½•çŠ¶æ€ä¿æŒ

### é¢„æœŸç»“æœ

- âœ… ç™»å½•æˆåŠŸæç¤º
- âœ… æ§åˆ¶å°è¾“å‡º: `âœ… ç™»å½•æˆåŠŸ: { username: 'xxx', role: 'xxx', token: '...' }`
- âœ… è‡ªåŠ¨è·³è½¬åˆ°å¯¹åº”è§’è‰²çš„é¦–é¡µ
- âœ… ä¸ä¼šå‡ºç° 403 æˆ–é‡å®šå‘åˆ°ç™»å½•é¡µ

## ğŸ¯ æ ¸å¿ƒè¦ç‚¹æ€»ç»“

1. **é¿å…åœ¨è·³è½¬å‰ä¾èµ– computed å€¼** - ä½¿ç”¨ç›´æ¥ä¼ å…¥çš„æ•°æ®
2. **æ·»åŠ å¿…è¦çš„å»¶è¿Ÿ** - ç¡®ä¿å“åº”å¼çŠ¶æ€å®Œå…¨æ›´æ–°
3. **è·¯ç”±å®ˆå«è¦æ£€æŸ¥çŠ¶æ€å®Œæ•´æ€§** - é¿å…åœ¨çŠ¶æ€æœªå°±ç»ªæ—¶åˆ¤æ–­æƒé™
4. **æ·»åŠ è°ƒè¯•æ—¥å¿—** - å¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ å•å…ƒæµ‹è¯•** - æµ‹è¯•ç™»å½•æµç¨‹å„ä¸ªç¯èŠ‚
2. **ä½¿ç”¨ TypeScript ä¸¥æ ¼æ¨¡å¼** - é¿å… undefined/null é—®é¢˜
3. **è€ƒè™‘ä½¿ç”¨ Pinia æ’ä»¶** - è‡ªåŠ¨åŒæ­¥çŠ¶æ€åˆ° localStorage
4. **æ·»åŠ ç™»å½•çŠ¶æ€è¿‡æœŸæ£€æµ‹** - å®šæ—¶æ£€æŸ¥ token æœ‰æ•ˆæ€§

---

**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: å¾…éªŒè¯  
**å½±å“èŒƒå›´**: ç™»å½•æµç¨‹ã€è·¯ç”±å®ˆå«ã€æƒé™æ£€æŸ¥
